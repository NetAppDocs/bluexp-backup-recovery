---
sidebar: sidebar
permalink: task-backup-onprem-to-gcp.html
keywords: backing up, back up, backup, backup on-prem ontap, on-premises, back up volumes, cloud backup, gcp, google cloud
summary: Complete a few steps to get started backing up volume data from your on-premises ONTAP systems to Google Cloud Storage.
---

= Backing up on-premises ONTAP data to Google Cloud Storage
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./media/

[.lead]
Complete a few steps to get started backing up volume data from your on-premises ONTAP systems to Google Cloud Storage.

Note that "on-premises ONTAP systems" includes FAS, AFF, and ONTAP Select systems.

== Quick start

Get started quickly by following these steps, or scroll down to the remaining sections for full details.

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-1.png[One] Verify support for your configuration

[role="quick-margin-list"]
* You have discovered the on-premises cluster and added it as a working environment in BlueXP. See https://docs.netapp.com/us-en/cloud-manager-ontap-onprem/task-discovering-ontap.html[Discovering ONTAP clusters^] for details.
** The cluster is running ONTAP 9.7P5 or later (ONTAP 9.8P13 and later is recommended).
** The cluster has a SnapMirror license -- it is included as part of the Premium Bundle or Data Protection Bundle.
** The cluster must have the required network connections to Google storage and to the Connector.
* The Connector must have the required network connections to Google storage and to the cluster.
* You have a valid Google subscription for the object storage space where your backups will be located.
* You have a Google account with an access key and secret key so the ONTAP cluster can back up and restore data.

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-2.png[Two] Enable BlueXP backup and recovery on the system

[role="quick-margin-para"]
Select the working environment and click *Enable > Backup Volumes* next to the Backup and recovery service in the right-panel, and then follow the setup wizard.

[role="quick-margin-para"]
image:screenshot_backup_onprem_enable.png[A screenshot that shows the Backup and recovery Enable button which is available after you select a working environment.]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-3.png[Three] Select the cloud provider and enter the provider details

[role="quick-margin-para"]
Select Google Cloud as your provider and then enter the provider details. You'll need to specify the IPspace in the ONTAP cluster where the volumes reside. You can also choose your own customer-managed keys for data encryption instead of using the default Google-managed encryption key.

[role="quick-margin-para"]
image:screenshot_backup_onprem_to_google.png[A screenshot that shows the cloud provider details when backing up volumes from an on-prem ONTAP system to a Google Cloud Storage bucket.]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-4.png[Four] Define the default backup policy

[role="quick-margin-para"]
The default policy backs up volumes every day and retains the most recent 30 backup copies of each volume. Change to hourly, daily, weekly, monthly, or yearly backups, or select one of the system-defined policies that provide more options. You can also change the number of backup copies you want to retain.

[role="quick-margin-para"]
Backups are stored in Standard storage by default. If your cluster is using ONTAP 9.12.1 or greater, you can choose to tier backups to Google Archive storage after a certain number of days for further cost optimization. link:concept-cloud-backup-policies.html[Learn more about the available BlueXP backup and recovery policy configuration settings^].

[role="quick-margin-para"]
image:screenshot_backup_policy_gcp.png[A screenshot that shows the BlueXP backup and recovery settings where you can choose the backup schedule and retention period.]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-5.png[Five] Select the volumes that you want to back up

[role="quick-margin-para"]
Identify which volumes you want to back up using the default backup policy in the Select Volumes page. If you want to assign different backup policies to certain volumes, you can create additional policies and apply them to volumes later.

== Requirements

Read the following requirements to make sure you have a supported configuration before you start backing up on-premises volumes to Google Cloud storage.

There are two connection methods you can use when configuring backups from on-premises ONTAP systems to Google Cloud Storage.

* Public connection - Directly connect the ONTAP system to Google Cloud Storage using a public Google endpoint.
* Private connection - Use a VPN or Google Cloud Interconnect and route traffic through a Private Google Access interface that uses a private IP address.

The following diagram shows the *public connection* method and the connections that you need to prepare between the components. The Connector must be deployed in the Google Cloud Platform VPC.
//You can use a Connector that you've installed on your premises, or a Connector that you've deployed in the Google Cloud Platform VPC.

image:diagram_cloud_backup_onprem_gcp_public.png[A diagram showing how BlueXP backup and recovery communicates over a public connection with the volumes on the cluster and the Google Cloud storage where the backup files are located.]

The following diagram shows the *private connection* method and the connections that you need to prepare between the components. The Connector must be deployed in the Google Cloud Platform VPC.
//You can use a Connector that you've installed on your premises, or a Connector that you've deployed in the Google Cloud Platform VPC.

image:diagram_cloud_backup_onprem_gcp_private.png[A diagram showing how BlueXP backup and recovery communicates over a private connection with the volumes on the cluster and the Google Cloud storage where the backup files are located.]

=== Preparing your ONTAP clusters

You need to discover your on-premises ONTAP clusters in BlueXP before you can start backing up volume data.

https://docs.netapp.com/us-en/cloud-manager-ontap-onprem/task-discovering-ontap.html[Learn how to discover a cluster^].

ONTAP requirements::
* Minimum of ONTAP 9.7P5; ONTAP 9.8P13 and later is recommended.
* A SnapMirror license (included as part of the Premium Bundle or Data Protection Bundle).
+
*Note:* The "Hybrid Cloud Bundle" is not required when using BlueXP backup and recovery.
+
See how to https://docs.netapp.com/us-en/ontap/system-admin/manage-licenses-concept.html[manage your cluster licenses^].
* Time and time zone are set correctly.
+
See how to https://docs.netapp.com/us-en/ontap/system-admin/manage-cluster-time-concept.html[configure your cluster time^].

Cluster networking requirements::
* The ONTAP cluster initiates an HTTPS connection over port 443 from the intercluster LIF to Google Cloud storage for backup and restore operations.
+
ONTAP reads and writes data to and from object storage. The object storage never initiates, it just responds.
+
* ONTAP requires an inbound connection from the Connector to the cluster management LIF. The Connector can reside in a Google Cloud Platform VPC.

* An intercluster LIF is required on each ONTAP node that hosts the volumes you want to back up. The LIF must be associated with the _IPspace_ that ONTAP should use to connect to object storage. https://docs.netapp.com/us-en/ontap/networking/standard_properties_of_ipspaces.html[Learn more about IPspaces^].
+
When you set up BlueXP backup and recovery, you are prompted for the IPspace to use. You should choose the IPspace that each LIF is associated with. That might be the "Default" IPspace or a custom IPspace that you created.
* The nodes' intercluster LIFs are able to access the object store.
* DNS servers have been configured for the storage VM where the volumes are located. See how to https://docs.netapp.com/us-en/ontap/networking/configure_dns_services_auto.html[configure DNS services for the SVM^].
+
If you're using Private Google Access or Private Service Connect, make sure your DNS servers have been configured to point `storage.googleapis.com` to the correct internal (private) IP address. 
* Note that if you use are using a different IPspace than the Default, then you might need to create a static route to get access to the object storage.
* Update firewall rules, if necessary, to allow BlueXP backup and recovery connections from ONTAP to object storage through port 443, and name resolution traffic from the storage VM to the DNS server over port 53 (TCP/UDP).

=== Creating or switching Connectors

If you already have a Connector deployed in your Google Cloud Platform VPC, then you're all set. If not, then you'll need to create a Connector in that location to back up ONTAP data to Google Cloud storage. You can't use a Connector that's deployed in another cloud provider, or on-premises.
//If you already have a Connector deployed in your Google Cloud Platform VPC or on your premises, then you're all set. If not, then you'll need to create a Connector in either of those locations to back up ONTAP data to Google Cloud storage. You can't use a Connector that's deployed in another cloud provider.

* https://docs.netapp.com/us-en/cloud-manager-setup-admin/concept-connectors.html[Learn about Connectors^]
* https://docs.netapp.com/us-en/cloud-manager-setup-admin/task-quick-start-connector-google.html[Installing a Connector in GCP^]
//* https://docs.netapp.com/us-en/cloud-manager-setup-admin/task-install-connector-on-prem.html[Installing a Connector in your premises^]

=== Preparing networking for the Connector

Ensure that the Connector has the required networking connections.

.Steps

. Ensure that the network where the Connector is installed enables the following connections:

* An HTTPS connection over port 443 to the BlueXP backup and recovery service and to your Google Cloud storage (https://docs.netapp.com/us-en/cloud-manager-setup-admin/task-set-up-networking-google.html#endpoints-contacted-for-day-to-day-operations[see the list of endpoints^])
* An HTTPS connection over port 443 to your ONTAP cluster management LIF

. Enable Private Google Access (or Private Service Connect) on the subnet where you plan to deploy the Connector. https://cloud.google.com/vpc/docs/configure-private-google-access[Private Google Access^] or https://cloud.google.com/vpc/docs/configure-private-service-connect-apis#on-premises[Private Service Connect^] are needed if you have a direct connection from your ONTAP cluster to the VPC and you want communication between the Connector and Google Cloud Storage to stay in your virtual private network (a *private* connection).
+
Follow the Google instructions for setting up these Private access options. Make sure your DNS servers have been configured to point `www.googleapis.com` and `storage.googleapis.com` to the correct internal (private) IP addresses.

=== Verify or add permissions to the Connector

To use the BlueXP backup and recovery "Search & Restore" functionality, you need to have specific permissions in the role for the Connector so that it can access the Google Cloud BigQuery service. See the permissions below, and follow the steps if you need to modify the policy.

.Steps

. In the https://console.cloud.google.com[Google Cloud Console^], go to the *Roles* page.

. Using the drop-down list at the top of the page, select the project or organization that contains the role that you want to edit.

. Click a custom role.

. Click *Edit Role* to update the role's permissions.

. Click *Add Permissions* to add the following new permissions to the role.
+
[source,json]
bigquery.jobs.get
bigquery.jobs.list
bigquery.jobs.listAll
bigquery.datasets.create
bigquery.datasets.get
bigquery.jobs.create
bigquery.tables.get
bigquery.tables.getData
bigquery.tables.list
bigquery.tables.create

. Click *Update* to save the edited role.

=== Preparing Google Cloud Storage for backups

When you set up backup, you need to provide storage access keys for a service account that has specific permissions. A service account enables BlueXP backup and recovery to authenticate and access Cloud Storage buckets used to store backups. The keys are required so that Google Cloud Storage knows who is making the request.

.Steps

. In the https://console.cloud.google.com[Google Cloud Console^], go to the *Roles* page.

. https://cloud.google.com/iam/docs/creating-custom-roles#creating_a_custom_role[Create a new role^] with the following permissions:
+
[source,json]
storage.buckets.create
storage.buckets.delete
storage.buckets.get
storage.buckets.list
storage.buckets.update
storage.buckets.getIamPolicy
storage.multipartUploads.create
storage.objects.create
storage.objects.delete
storage.objects.get
storage.objects.list
storage.objects.update

. In the Google Cloud console, https://console.cloud.google.com/iam-admin/serviceaccounts[go to the Service accounts page^].

. Select your Cloud project.

. Click *Create service account* and provide the required information:

.. *Service account details*: Enter a name and description.
.. *Grant this service account access to project*: Select the custom role that you just created.
.. Click *Done*.

. Go to https://console.cloud.google.com/storage/settings[GCP Storage Settings^] and create access keys for the service account:

.. Select a project, and click *Interoperability*. If you haven't already done so, click *Enable interoperability access*.

.. Under *Access keys for service accounts*, click *Create a key for a service account*, select the service account that you just created, and click *Create Key*.
+
You'll need to enter the keys in BlueXP backup and recovery later when you configure the backup service.

==== Using customer-managed encryption keys (CMEK)

You can use your own customer-managed keys for data encryption instead of using the default Google-managed encryption keys. Both cross-region and cross-project keys are supported, so you can choose a project for a bucket that is different than the project of the CMEK key. If you're planning to use your own customer-managed keys: 

* You'll need to have the Key Ring and the Key Name so you can add this information in the activation wizard. https://cloud.google.com/kms/docs/cmek[Learn more about customer-managed encryption keys^].

* You'll need to verify that these required permissions are included in the role for the Connector:
+
[source,json]
cloudkms.cryptoKeys.get
cloudkms.cryptoKeys.getIamPolicy
cloudkms.cryptoKeys.list
cloudkms.cryptoKeys.setIamPolicy
cloudkms.keyRings.get
cloudkms.keyRings.getIamPolicy
cloudkms.keyRings.list
cloudkms.keyRings.setIamPolicy

* You'll need to verify that the Google "Cloud Key Management Service (KMS)" API is enabled in your project. See the https://cloud.google.com/apis/docs/getting-started#enabling_apis[Google Cloud documentation: Enabling APIs] for details.

*CMEK considerations:*

* Both HSM (Hardware-backed) and Software-generated keys are supported.
* Both newly created or imported Cloud KMS keys are supported.
* Only regional keys are supported, global keys are not supported.
* Currently, only the "Symmetric encrypt/decrypt" purpose is supported.
* The service agent associated with the Storage Account is assigned the "CryptoKey Encrypter/Decrypter (roles/cloudkms.cryptoKeyEncrypterDecrypter)" IAM role by BlueXP backup and recovery. 

=== Verify license requirements

* Before you can activate BlueXP backup and recovery for your cluster, you'll need to either subscribe to a pay-as-you-go (PAYGO) BlueXP Marketplace offering from Google, or purchase and activate a BlueXP backup and recovery BYOL license from NetApp. These licenses are for your account and can be used across multiple systems.

** For BlueXP backup and recovery PAYGO licensing, you'll need a subscription to the https://console.cloud.google.com/marketplace/details/netapp-cloudmanager/cloud-manager?supportedpurview=project[NetApp BlueXP offering from the Google Marketplace^]. Billing for BlueXP backup and recovery is done through this subscription.
** For BlueXP backup and recovery BYOL licensing, you'll need the serial number from NetApp that enables you to use the service for the duration and capacity of the license. link:task-licensing-cloud-backup.html#use-a-bluexp-backup-and-recovery-byol-license[Learn how to manage your BYOL licenses].

* You need to have a Google subscription for the object storage space where your backups will be located.
+
You can create backups from on-premises systems to Google Cloud Storage in all regions https://cloud.netapp.com/cloud-volumes-global-regions[where Cloud Volumes ONTAP is supported^]. You specify the region where backups will be stored when you set up the service.

== Enabling BlueXP backup and recovery

Enable BlueXP backup and recovery at any time directly from the on-premises working environment.

.Steps

. From the Canvas, select the working environment and click *Enable > Backup Volumes* next to the Backup and recovery service in the right-panel.
+
If the Google Cloud Storage destination for your backups exists as a working environment on the Canvas, you can drag the cluster onto the Google Cloud Storage working environment to initiate the setup wizard.
+
image:screenshot_backup_onprem_enable.png[A screenshot that shows the Backup and recovery Enable button which is available after you select a working environment.]

. Select Google Cloud as your provider and click *Next*.

. Enter the provider details and click *Next*.

.. The Google Cloud Project where you want the Google Cloud Storage bucket to be created for backups. (The Project must have a Service Account that has a custom role with specific permissions - <<Preparing Google Cloud Storage for backups,as described here>>.)
.. The Google Access Key and Secret Key used to store the backups.
.. The Google region where the backups will be stored.
.. The IPspace in the ONTAP cluster where the volumes you want to back up reside. The intercluster LIFs for this IPspace must have outbound internet access.
.. Whether you'll use the default Google-managed encryption key or choose your own customer-managed keys to manage encryption of your data. To use a CMEK, you'll need to have the Key Ring and the Key Name. https://cloud.google.com/kms/docs/cmek[Learn more about customer-managed encryption keys^].
+
image:screenshot_backup_onprem_to_google.png[A screenshot that shows the cloud provider details when backing up volumes from an on-premises cluster to Google Cloud Storage.]

. If you don't have an existing BlueXP backup and recovery license for your account, you'll be prompted at this point to select the type of charging method that you want to use. You can subscribe to a pay-as-you-go (PAYGO) BlueXP Marketplace offering from Google (or if you have multiple subscriptions you'll need to select one), or purchase and activate a BlueXP backup and recovery BYOL license from NetApp. link:task-licensing-cloud-backup.html[Learn how to set up BlueXP backup and recovery licensing.]

. Enter the backup policy details that will be used for your default policy and click *Next*. You can select an existing policy, or you can create a new policy by entering your selections in each section:

.. Enter the name for the default policy. You don't need to change the name.
.. Define the backup schedule and choose the number of backups to retain. link:concept-ontap-backup-to-cloud.html#customizable-backup-schedule-and-retention-settings[See the list of existing policies you can choose^].
.. When using ONTAP 9.12.1 or greater, you can choose to tier backups to Archive storage after a certain number of days for further cost optimization. link:concept-cloud-backup-policies.html[Learn more about the available BlueXP backup and recovery policy configuration settings^].
+
image:screenshot_backup_policy_gcp.png[A screenshot that shows the BlueXP backup and recovery settings where you can choose your backup schedule and retention period.]

. Select the volumes that you want to back up using the defined backup policy in the Select Volumes page. If you want to assign different backup policies to certain volumes, you can create additional policies and apply them to those volumes later.

+
* To back up all existing volumes and any volumes added in the future, check the box "Back up all existing and future volumes...". We recommend this option so that all your volumes will be backed up and you'll never have to remember to enable backups for new volumes.
* To back up only existing volumes, check the box in the title row (image:button_backup_all_volumes.png[]).
* To back up individual volumes, check the box for each volume (image:button_backup_1_volume.png[]).
+
image:screenshot_backup_select_volumes.png[A screenshot of selecting the volumes that will be backed up.]

+
* If there are any local Snapshot copies for read/write volumes in this working environment that match the backup schedule label you just selected for this working environment (for example, daily, weekly, etc.), an additional prompt is displayed "Export existing Snapshot copies to object storage as backup copies". Check this box if you want all historic Snapshots to be copied to object storage as backup files to ensure the most complete protection for your volumes.

. Click *Activate Backup* and BlueXP backup and recovery starts taking the initial backups of your volumes.

.Result

A Google Cloud Storage bucket is created automatically in the service account indicated by the Google access key and secret key you entered, and the backup files are stored there. The Volume Backup Dashboard is displayed so you can monitor the state of the backups. You can also monitor the status of backup and restore jobs using the link:task-monitor-backup-jobs.html[Job Monitoring panel^].

== What's next?

* You can link:task-manage-backups-ontap.html[manage your backup files and backup policies^]. This includes starting and stopping backups, deleting backups, adding and changing the backup schedule, and more.
* You can link:task-manage-backup-settings-ontap.html[manage cluster-level backup settings^]. This includes changing the storage keys ONTAP uses to access cloud storage, changing the network bandwidth available to upload backups to object storage, changing the automatic backup setting for future volumes, and more.
* You can also link:task-restore-backups-ontap.html[restore volumes, folders, or individual files from a backup file^] to a Cloud Volumes ONTAP system in Google, or to an on-premises ONTAP system.
